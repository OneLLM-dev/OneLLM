name: Deploy Rust App to EC2

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          envs: OPENAI,CLAUDE,DEEPSEEK
          script: |
            set -e

            echo "ðŸ”„ Changing to project directory..."
            cd /home/ubuntu/OneLLM/OneLLM

            echo "ðŸ”§ Setting SSH Git remote (if needed)..."
            git remote set-url origin git@github.com:OneLLM-dev/OneLLM.git

            echo "ðŸ“¦ Pulling latest changes from Git..."
            git pull origin production

            echo "ðŸ”¨ Building Rust app..."
            source $HOME/.cargo/env
            cargo build --release -p oneAI-backend

            echo "ðŸš€ Restarting app..."
            pkill oneAI-backend || true

            OPENAI=${{ secrets.OPENAI }} \
            CLAUDE=${{ secrets.CLAUDE }} \
            DEEPSEEK=${{ secrets.DEEPSEEK }} \
            nohup ./target/release/oneAI-backend > output.log 2>&1 &
